import React, { useState, useEffect, useRef } from 'react';
import { Play, RotateCcw, Volume2, Star, Trophy, AlertCircle } from 'lucide-react';

// --- DATA HEWAN (80 Hewan) ---
const rawAnimals = [
    // --- LEVEL 1: MUDAH (Hijau) ---
    { name: "Kucing", keyword: "cute cat" }, { name: "Anjing", keyword: "cute dog" },
    { name: "Ayam", keyword: "cute chicken" }, { name: "Bebek", keyword: "cute duck" },
    { name: "Sapi", keyword: "cute cow" }, { name: "Kambing", keyword: "cute goat" },
    { name: "Domba", keyword: "cute sheep" }, { name: "Kuda", keyword: "cute horse" },
    { name: "Kelinci", keyword: "cute rabbit" }, { name: "Ikan", keyword: "cute fish" },
    { name: "Burung", keyword: "cute bird" }, { name: "Kupu-kupu", keyword: "cute butterfly" },
    { name: "Semut", keyword: "cute ant" }, { name: "Nyamuk", keyword: "cute mosquito" },
    { name: "Lalat", keyword: "cute fly" }, { name: "Cicak", keyword: "cute lizard" },
    { name: "Tikus", keyword: "cute mouse" }, { name: "Katak", keyword: "cute frog" },
    { name: "Ular", keyword: "cute snake" }, { name: "Kura-kura", keyword: "cute turtle" },

    // --- LEVEL 2: SEDANG (Oranye) ---
    { name: "Gajah", keyword: "cute elephant" }, { name: "Singa", keyword: "cute lion" },
    { name: "Harimau", keyword: "cute tiger" }, { name: "Jerapah", keyword: "cute giraffe" },
    { name: "Monyet", keyword: "cute monkey" }, { name: "Zebra", keyword: "cute zebra" },
    { name: "Beruang", keyword: "cute bear" }, { name: "Panda", keyword: "cute panda" },
    { name: "Koala", keyword: "cute koala" }, { name: "Kangguru", keyword: "cute kangaroo" },
    { name: "Buaya", keyword: "cute crocodile" }, { name: "Kuda Nil", keyword: "cute hippo" },
    { name: "Badak", keyword: "cute rhino" }, { name: "Rusa", keyword: "cute deer" },
    { name: "Serigala", keyword: "cute wolf" }, { name: "Rubah", keyword: "cute fox" },
    { name: "Burung Hantu", keyword: "cute owl" }, { name: "Pinguin", keyword: "cute penguin" },
    { name: "Lumba-lumba", keyword: "cute dolphin" }, { name: "Hiu", keyword: "cute shark" },

    // --- LEVEL 3: SULIT (Merah) ---
    { name: "Gurita", keyword: "cute octopus" }, { name: "Kepiting", keyword: "cute crab" },
    { name: "Udang", keyword: "cute shrimp" }, { name: "Ubur-ubur", keyword: "cute jellyfish" },
    { name: "Bintang Laut", keyword: "cute starfish" }, { name: "Kuda Laut", keyword: "cute seahorse" },
    { name: "Anjing Laut", keyword: "cute seal" }, { name: "Walrus", keyword: "cute walrus" },
    { name: "Berang-berang", keyword: "cute beaver" }, { name: "Landak", keyword: "cute hedgehog" },
    { name: "Tupai", keyword: "cute squirrel" }, { name: "Kelelawar", keyword: "cute bat" },
    { name: "Lebah", keyword: "cute bee" }, { name: "Capung", keyword: "cute dragonfly" },
    { name: "Kumbang", keyword: "cute beetle" }, { name: "Laba-laba", keyword: "cute spider" },
    { name: "Kalajengking", keyword: "cute scorpion" }, { name: "Unta", keyword: "cute camel" },
    { name: "Gorila", keyword: "cute gorilla" }, { name: "Bunglon", keyword: "cute chameleon" },

    // --- LEVEL 4: MUSTAHIL/EXPERT (Ungu) ---
    { name: "Komodo", keyword: "komodo dragon" }, { name: "Platypus", keyword: "cute platypus" },
    { name: "Sloth", keyword: "cute sloth" }, { name: "Lemur", keyword: "cute lemur" },
    { name: "Tapir", keyword: "cute tapir" }, { name: "Trenggiling", keyword: "cute pangolin" },
    { name: "Bekantan", keyword: "proboscis monkey" }, { name: "Cendrawasih", keyword: "bird of paradise" },
    { name: "Flamingo", keyword: "cute flamingo" }, { name: "Burung Pelikan", keyword: "cute pelican" },
    { name: "Burung Unta", keyword: "cute ostrich" }, { name: "Kalkun", keyword: "cute turkey" },
    { name: "Angsa", keyword: "cute swan" }, { name: "Musang", keyword: "cute ferret" },
    { name: "Rakun", keyword: "cute raccoon" }, { name: "Hyena", keyword: "cute hyena" },
    { name: "Cheetah", keyword: "cute cheetah" }, { name: "Macan Tutul", keyword: "cute leopard" },
    { name: "Bison", keyword: "cute bison" }, { name: "Armadillo", keyword: "cute armadillo" }
];

// Menambahkan properti level, ID, DAN SEED STABIL
const animalsData = rawAnimals.map((animal, index) => {
    let level = "MUDAH";
    let color = "bg-green-500";
    let levelId = 1;
    
    if (index >= 60) { level = "MUSTAHIL"; color = "bg-purple-600"; levelId = 4; }
    else if (index >= 40) { level = "SULIT"; color = "bg-red-500"; levelId = 3; }
    else if (index >= 20) { level = "SEDANG"; color = "bg-orange-500"; levelId = 2; }

    // PENTING: Generate seed di sini sekali saja agar konsisten antara preload dan display
    const seed = Math.floor(Math.random() * 999999); 

    return { ...animal, id: index + 1, level, color, levelId, seed };
});

// Helper Function untuk mendapatkan URL yang konsisten
const getImageUrl = (animal) => {
    // Prompt dioptimalkan
    const prompt = `cute 3d cartoon character of ${animal.keyword}, isolated on simple bright background, pixar style, high quality`;
    // Gunakan seed yang sudah disimpan di objek animal
    return `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=1280&height=720&nologo=true&seed=${animal.seed}`;
};

const LevelIntro = ({ levelName, color, onContinue }) => {
    return (
        <div className={`w-full h-full ${color} flex flex-col items-center justify-center text-white p-8 animate-in fade-in duration-500`}>
            <Trophy size={80} className="mb-6 animate-bounce" />
            <h2 className="text-4xl font-bold mb-2 opacity-80">LEVEL SELANJUTNYA</h2>
            <h1 className="text-8xl font-black mb-8 tracking-widest text-shadow-lg">{levelName}</h1>
            <button 
                onClick={onContinue}
                className="bg-white text-gray-900 text-3xl font-bold py-4 px-12 rounded-full shadow-lg hover:scale-105 transition-transform"
            >
                LANJUT â–¶
            </button>
        </div>
    );
};

const GameScreen = ({ animal, onNext }) => {
    const [phase, setPhase] = useState('loading'); // loading, guess, reveal
    const [timeLeft, setTimeLeft] = useState(4);
    const [imgUrl, setImgUrl] = useState('');
    const synth = window.speechSynthesis;

    useEffect(() => {
        setPhase('loading');
        setTimeLeft(4);
        
        // Gunakan helper function yang sama persis
        const url = getImageUrl(animal);
        
        // Pre-check jika gambar sudah ada di cache browser
        const img = new Image();
        img.src = url;
        if (img.complete) {
             setImgUrl(url);
             setPhase('guess');
        } else {
            setImgUrl(url);
            img.onload = () => setPhase('guess');
        }

    }, [animal]);

    // Logika Timer
    useEffect(() => {
        let interval;
        if (phase === 'guess' && timeLeft > 0) {
            interval = setInterval(() => {
                setTimeLeft((prev) => prev - 1);
            }, 1000);
        } else if (phase === 'guess' && timeLeft === 0) {
            setPhase('reveal');
        }
        return () => clearInterval(interval);
    }, [phase, timeLeft]);

    useEffect(() => {
        if (phase === 'reveal') {
            const utterance = new SpeechSynthesisUtterance(animal.name);
            utterance.lang = 'id-ID'; 
            utterance.rate = 0.9; 
            utterance.pitch = 1.1; 
            
            const voices = synth.getVoices();
            const indoVoice = voices.find(v => v.lang.includes('id') && v.name.includes('Google'));
            if (indoVoice) utterance.voice = indoVoice;

            synth.speak(utterance);

            const nextTimer = setTimeout(() => {
                onNext();
            }, 4000); 

            return () => clearTimeout(nextTimer);
        }
    }, [phase, animal, onNext]);

    return (
        <div className="w-full h-full bg-slate-50 relative flex flex-col font-sans overflow-hidden">
            {/* Header Bar */}
            <div className={`w-full py-3 px-6 flex justify-between items-center text-white shadow-md z-10 ${animal.color}`}>
                <div className="flex items-center gap-2">
                    <span className="font-bold text-xl bg-white/20 px-3 py-1 rounded">
                        LEVEL {animal.levelId}
                    </span>
                    <span className="font-black text-2xl tracking-wider">{animal.level}</span>
                </div>
                <div className="text-xl font-bold bg-white/20 px-4 py-1 rounded-full">
                   #{animal.id} / 80
                </div>
            </div>

            {/* Area Gambar Utama */}
            <div className="flex-1 flex items-center justify-center relative overflow-hidden bg-gray-100">
                {/* Loading */}
                {phase === 'loading' && (
                    <div className="flex flex-col items-center animate-pulse text-gray-400">
                        <div className="text-6xl mb-4">ðŸŽ¨</div>
                        <p className="text-xl font-bold">Menggambar {animal.name}...</p>
                        <p className="text-sm mt-2">(Memastikan gambar siap...)</p>
                    </div>
                )}

                {/* Gambar */}
                <img 
                    src={imgUrl} 
                    alt="Tebak Hewan" 
                    className={`
                        h-full w-full object-contain object-center transition-all duration-500
                        ${phase === 'loading' ? 'opacity-0 scale-90' : 'opacity-100 scale-100'}
                    `}
                />

                {/* Overlay Hitung Mundur Besar */}
                {phase === 'guess' && (
                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pointer-events-none">
                         <div className="text-[15rem] font-black text-white drop-shadow-[0_0_15px_rgba(0,0,0,0.5)] opacity-40 animate-ping">
                            {timeLeft}
                        </div>
                    </div>
                )}

                {/* Reveal Name Bar */}
                <div className={`
                    absolute bottom-8 left-0 right-0 mx-auto w-3/4
                    bg-white rounded-2xl shadow-[0_10px_25px_rgba(0,0,0,0.3)]
                    border-l-8 ${animal.color.replace('bg-', 'border-')}
                    flex items-center justify-center py-4
                    transition-all duration-500 transform
                    ${phase === 'reveal' ? 'translate-y-0 opacity-100' : 'translate-y-20 opacity-0'}
                `}>
                    <h1 className="text-6xl font-black text-gray-800 uppercase tracking-widest text-center">
                        {animal.name}
                    </h1>
                </div>
            </div>

            {/* Progress Bar Waktu */}
            <div className="h-6 w-full bg-gray-300 relative">
                <div 
                    className={`h-full transition-all duration-1000 ease-linear ${
                        timeLeft > 2 ? 'bg-green-500' : timeLeft > 1 ? 'bg-yellow-500' : 'bg-red-600'
                    }`}
                    style={{ width: phase === 'guess' ? `${(timeLeft / 4) * 100}%` : '100%' }}
                />
            </div>
        </div>
    );
};

const StartScreen = ({ onStart }) => {
    return (
        <div className="w-full h-full bg-gradient-to-br from-blue-500 via-indigo-600 to-purple-700 flex flex-col items-center justify-center text-white relative font-sans p-8 text-center">
            <h1 className="text-7xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-yellow-500 drop-shadow-sm" style={{ WebkitTextStroke: '1px white' }}>
                TEBAK NAMA HEWAN
            </h1>
            <div className="flex gap-2 mb-8">
                <span className="bg-green-500 px-3 py-1 rounded text-sm font-bold">MUDAH</span>
                <span className="bg-orange-500 px-3 py-1 rounded text-sm font-bold">SEDANG</span>
                <span className="bg-red-500 px-3 py-1 rounded text-sm font-bold">SULIT</span>
                <span className="bg-purple-600 px-3 py-1 rounded text-sm font-bold">MUSTAHIL</span>
            </div>
            
            <p className="text-2xl mb-12 max-w-2xl leading-relaxed opacity-90">
                Bisakah kamu menebak 80 hewan ini dalam 4 detik? Ayo uji pengetahuanmu!
            </p>

            <button 
                onClick={onStart}
                className="group relative bg-yellow-400 text-yellow-900 text-4xl font-black py-6 px-20 rounded-3xl shadow-[0_10px_0_rgb(161,98,7)] transition-all hover:translate-y-1 hover:shadow-[0_5px_0_rgb(161,98,7)] active:translate-y-2 active:shadow-none flex items-center gap-4"
            >
                <Play size={48} fill="currentColor" />
                MAIN SEKARANG
            </button>
            <div className="mt-6 flex items-center gap-2 text-white/70">
                <Volume2 size={20} /> <span className="text-lg">Suara aktif otomatis</span>
            </div>
        </div>
    );
};

const EndScreen = ({ onRestart }) => {
    return (
        <div className="w-full h-full bg-gradient-to-tr from-green-400 to-blue-500 flex flex-col items-center justify-center text-white text-center p-10 font-sans">
            <div className="mb-8 relative">
                <Star size={120} className="text-yellow-300 animate-spin-slow absolute top-0 left-0 right-0 bottom-0 m-auto blur-xl opacity-50" />
                <Trophy size={100} className="text-yellow-300 relative z-10 drop-shadow-lg" />
            </div>
            <h1 className="text-8xl font-black mb-4 text-white drop-shadow-md">LUAR BIASA!</h1>
            <p className="text-3xl mb-12 font-medium opacity-90">Kamu berhasil menaklukkan level MUSTAHIL!</p>
            <button 
                onClick={onRestart}
                className="bg-white text-blue-600 text-3xl font-bold py-4 px-12 rounded-full shadow-xl hover:scale-105 transition-transform flex items-center gap-3"
            >
                <RotateCcw size={32} /> Main Lagi
            </button>
        </div>
    );
};

export default function App() {
    const [gameState, setGameState] = useState('start'); // start, intro, playing, finished
    const [currentIdx, setCurrentIdx] = useState(0);

    // --- FUNGSI PRELOAD AGRESIF ---
    useEffect(() => {
        // Preload 5 gambar pertama saat app pertama kali dimuat (di Start Screen)
        const PRELOAD_BATCH = 5;
        for (let i = 0; i < PRELOAD_BATCH; i++) {
            if (i < animalsData.length) {
                const img = new Image();
                img.src = getImageUrl(animalsData[i]);
            }
        }
    }, []);

    useEffect(() => {
        if (gameState === 'playing') {
            // Buffer: Selalu pastikan 5 gambar KEDEPAN sudah didownload
            const PRELOAD_AHEAD = 5;
            for (let i = 1; i <= PRELOAD_AHEAD; i++) {
                const targetIdx = currentIdx + i;
                if (targetIdx < animalsData.length) {
                    const img = new Image();
                    img.src = getImageUrl(animalsData[targetIdx]);
                }
            }
        }
    }, [currentIdx, gameState]);
    // ---------------------------

    const handleNext = () => {
        const nextIdx = currentIdx + 1;
        if (nextIdx >= animalsData.length) {
            setGameState('finished');
        } else {
            if (animalsData[nextIdx].levelId > animalsData[currentIdx].levelId) {
                setGameState('levelIntro');
                setCurrentIdx(nextIdx); 
            } else {
                setCurrentIdx(nextIdx);
            }
        }
    };

    const handleStart = () => {
        setGameState('playing'); 
        setCurrentIdx(0);
    };

    // Inject Font
    useEffect(() => {
        const link = document.createElement('link');
        link.href = "https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap";
        link.rel = "stylesheet";
        document.head.appendChild(link);
        return () => document.head.removeChild(link);
    }, []);

    return (
        <div className="min-h-screen w-full flex items-center justify-center p-4 bg-gray-900" style={{ fontFamily: "'Nunito', sans-serif" }}>
             <style>{`
                @keyframes spin-slow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                .animate-spin-slow { animation: spin-slow 10s linear infinite; }
                .text-shadow-lg { text-shadow: 4px 4px 0px rgba(0,0,0,0.2); }
            `}</style>
            
            <div className="w-full max-w-6xl aspect-video bg-white rounded-3xl shadow-2xl overflow-hidden relative border-[10px] border-white ring-4 ring-gray-800">
                {gameState === 'start' && <StartScreen onStart={handleStart} />}
                
                {gameState === 'levelIntro' && (
                    <LevelIntro 
                        levelName={animalsData[currentIdx].level} 
                        color={animalsData[currentIdx].color}
                        onContinue={() => setGameState('playing')}
                    />
                )}

                {gameState === 'playing' && (
                    <GameScreen 
                        animal={animalsData[currentIdx]} 
                        onNext={handleNext}
                    />
                )}
                
                {gameState === 'finished' && <EndScreen onRestart={() => window.location.reload()} />}
            </div>
        </div>
    );
}
